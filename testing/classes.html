<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Testing for Beginners">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="BEd2YAbpSQrRqU2-5wUifTTzvqTMGLLE269b0JZTfCs" />

    <title>Test Classes | Testing for Beginners</title>

    <link href="../assets/stylesheets/monstas-fe625f69.css" rel="stylesheet" type="text/css" />
  </head>

  <body>
    <nav class="page-nav"><a class="prev" href="/testing/stages.html">
  Previous
</a></nav>
    <nav class="page-nav"><a class="next" href="/libraries.html">
  Next
</a></nav>

    <div>
      <nav class="toc">
        <h1>Contents</h1>
        <ul>
  <li>
    <a href="/index.html">
      Testing For Beginners
    </a>
  </li>
  <li>
    <a href="/preface.html">
      Preface
    </a>
  </li>
  <li class="directory expanded">
    <a href="/testing.html">
      Testing Code
    </a>
    <ul>
      <li>
        <a href="/testing/output.html">
          Testing via output
        </a>
      </li>
      <li>
        <a href="/testing/separation.html">
          Separating test code
        </a>
      </li>
      <li>
        <a href="/testing/computed.html">
          Computed tests
        </a>
      </li>
      <li>
        <a href="/testing/assert.html">
          Assertions
        </a>
      </li>
      <li>
        <a href="/testing/stages.html">
          Stages of a test
        </a>
      </li>
      <li class="active">
        <a href="/testing/classes.html">
          Test Classes
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/libraries.html">
      Libraries
    </a>
  </li>
  <li>
    <a href="/minitest.html">
      Minitest
    </a>
  </li>
  <li class="directory">
    <a href="/rspec.html">
      RSpec
    </a>
    <ul>
      <li>
        <a href="/rspec/basics.html">
          Basic Usage
        </a>
      </li>
      <li>
        <a href="/rspec/matchers.html">
          Matchers
        </a>
      </li>
      <li>
        <a href="/rspec/format.html">
          Format
        </a>
      </li>
      <li>
        <a href="/rspec/advanced.html">
          Advanced Usage
        </a>
      </li>
      <li>
        <a href="/rspec/custom_matchers.html">
          Custom Matchers
        </a>
      </li>
      <li>
        <a href="/rspec/filtering.html">
          Filtering
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/rack_test.html">
      Rack::Test
    </a>
    <ul>
      <li>
        <a href="/rack_test/rack.html">
          Testing a Rack app
        </a>
      </li>
      <li>
        <a href="/rack_test/sinatra.html">
          Testing a Sinatra app
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/headless.html">
      Headless browsers
    </a>
    <ul>
      <li>
        <a href="/headless/phantomjs.html">
          Phantom.js
        </a>
      </li>
      <li>
        <a href="/headless/capybara.html">
          Capybara
        </a>
      </li>
      <li>
        <a href="/headless/features.html">
          Feature tests
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/test_doubles.html">
      Test doubles
    </a>
  </li>
  <li>
    <a href="/analysis.html">
      Code Analysis
    </a>
  </li>
  <li>
    <a href="/services.html">
      Services
    </a>
  </li>
</ul>
      </nav>
      <article>
        <nav class="menu"><a href="#"></a></nav>
        <h1>Test Classes</h1>

<p><em>Write your own little testing library</em></p>

<p>Ruby is an object-oriented programming language. So testing libraries often allow you
to implement your tests in the form of classes.</p>

<p>Let&rsquo;s write our own simple testing library.</p>

<p>Suppose we&rsquo;ve stored the <code>leap_year?</code> method in a file <code>leap_year.rb</code>, and the
<code>User</code> class in a file <code>user.rb</code>.</p>

<p>We&rsquo;d want the following code to work:</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s2">"date"</span>
<span class="nb">require</span> <span class="s2">"leap_year"</span>
<span class="nb">require</span> <span class="s2">"test"</span>

<span class="k">class</span> <span class="nc">User</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">birthday</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
    <span class="vi">@birthday</span> <span class="o">=</span> <span class="n">birthday</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">born_in_leap_year?</span>
    <span class="n">leap_year?</span><span class="p">(</span><span class="no">Date</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="vi">@birthday</span><span class="p">).</span><span class="nf">year</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">if</span> <span class="vg">$0</span> <span class="o">==</span> <span class="kp">__FILE__</span>
  <span class="k">class</span> <span class="nc">UserTest</span> <span class="o">&lt;</span> <span class="no">Test</span>
    <span class="k">def</span> <span class="nf">test_not_born_in_leap_year_when_born_in_2001</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Jennifer"</span><span class="p">,</span> <span class="s2">"2001-01-01"</span><span class="p">)</span>
      <span class="n">assert_false</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">born_in_leap_year?</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">test_not_born_in_leap_year_when_born_in_1900</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Jennifer"</span><span class="p">,</span> <span class="s2">"1900-01-01"</span><span class="p">)</span>
      <span class="n">assert_false</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">born_in_leap_year?</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">test_born_in_leap_year_when_born_in_2000</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Jennifer"</span><span class="p">,</span> <span class="s2">"2000-01-01"</span><span class="p">)</span>
      <span class="n">assert_true</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">born_in_leap_year?</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">test_born_in_leap_year_when_born_in_2004</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Jennifer"</span><span class="p">,</span> <span class="s2">"2004-01-01"</span><span class="p">)</span>
      <span class="n">assert_true</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nf">born_in_leap_year?</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="o">=</span> <span class="no">UserTest</span><span class="p">.</span><span class="nf">new</span>
  <span class="nb">test</span><span class="p">.</span><span class="nf">run</span>
<span class="k">end</span>
</code></pre>

<p>This is pretty much exactly how almost all Ruby tests looked like, maybe, 10
years ago. And it is still the style preferred by quite some Ruby developers.</p>

<p>The idea here is to represent each test with a method on a class. The method
should be as descriptive and readable as possible, and focus on the semantics,
instead of the implementation (i.e. what we test, not how we test).</p>

<p>However, this code will break, because the class <code>Test</code> does not exist. Also,
if you&rsquo;ve followed our curriculum you&rsquo;ll spot a new thing here:</p>
<pre class="highlight plaintext"><code>class UserTest &lt; Test
</code></pre>

<p>What&rsquo;s that?</p>

<p>The <code>&lt;</code> operator used here refers to a concept called &ldquo;inheritance&rdquo;. It says:
<em>Define a new class <code>UserTest</code> and inherit all the methods from the class <code>Test</code>.</em>
In other words <code>UserTest</code> <em>is</em> a <code>Test</code>, but it also adds some extra stuff to it.</p>

<p>We can define the class <code>Test</code> like so, and store it to a file <code>test.rb</code>:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Test</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="nb">methods</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="nb">method</span><span class="o">|</span> <span class="nb">method</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="s2">"test_"</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">tests</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="nb">test</span><span class="o">|</span> <span class="nb">send</span><span class="p">(</span><span class="nb">test</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">assert_true</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
    <span class="n">assert_equal</span><span class="p">(</span><span class="kp">true</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">assert_false</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
    <span class="n">assert_equal</span><span class="p">(</span><span class="kp">false</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">assert_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expected</span> <span class="o">==</span> <span class="n">actual</span>
      <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> is </span><span class="si">#{</span><span class="n">expected</span><span class="si">}</span><span class="s2"> as expected."</span>
    <span class="k">else</span>
      <span class="nb">puts</span> <span class="s2">"KAPUTT! </span><span class="si">#{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> is not </span><span class="si">#{</span><span class="n">expected</span><span class="si">}</span><span class="s2"> as expected."</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Whoa. That&rsquo;s a bunch of new stuff. If you don&rsquo;t grasp all of this don&rsquo;t worry,
it&rsquo;s certainly a level of Ruby knowledge you don&rsquo;t actually need this often.</p>

<p>Let&rsquo;s walk through it though:</p>

<ul>
<li><p>Our class <code>UserTest</code> inherits all the methods from the class <code>Test</code>. So we
can call the method <code>run</code> on our instance (as in <code>test.run</code>, from above).</p></li>
<li><p>The method <code>run</code> looks at all the <code>methods</code> defined on this object, and selects
the method names that start with the string <code>test_</code>. The <code>Test</code> class does not
have any such methods. So these must be the methods that we&rsquo;ve defined on the
class <code>UserTest</code>.</p></li>
<li><p>It then, for each of these method names, calls <code>send</code> with the given method name.
<code>send</code> calls this exact method on the object itself. That&rsquo;s right. <code>send</code> is
an abstract way of calling a method: You hand it the method name you want to
call, and it calls that method for you.</p></li>
<li><p>So we call all the methods <code>test_not_born_in_leap_year_when_born_in_2001</code>,
<code>test_not_born_in_leap_year_when_born_in_1900</code>, and so on.</p></li>
<li><p>Now these methods set up a <code>User</code> object with the birthday we care about, and
then call <code>assert_false</code> or <code>assert_true</code> with the actual that value the method
<code>born_in_leap_year?</code> returned.</p></li>
<li><p>The methods <code>assert_false</code> and <code>assert_true</code> just call <code>assert_equal</code>, passing
the expected value (<code>true</code> or <code>false</code>), and the actual value they received from
the test method.</p></li>
</ul>

<p>Pretty cool.</p>

<h2>Adding the test method name</h2>

<p>However, we&rsquo;re now missing some important information. If you try breaking the
first test by changing <code>2001</code> to <code>2000</code> in the birthday date (not the method
name), and run the output you&rsquo;ll see:</p>
<pre class="highlight plaintext"><code>$ ruby -I . user.rb
KAPUTT! true is not false as expected.
false is false as expected.
true is true as expected.
true is true as expected.
</code></pre>

<p>Umm. We&rsquo;ve lost the ability to easily identify which one of the test methods
broke. If we have a few hundred tests then counting them to figure out the
right one is not a cool option.</p>

<p>So how can we fix that?</p>

<p>We&rsquo;ve previously passed in an identifier to <code>assert_equal</code> by calling
something like <code>assert_equal(expected, actual, &quot;born_in_leap_year? for a User born on #{date}&quot;)</code>.</p>

<p>However, that requires us to type a lot of code every time we want to call any
of our assertion methods.</p>

<p>Luckily, Ruby allows us to grab the so called backtrace at any point in our
code. The backtrace is the funny looking stuff that you see on any error message
in the console. It is an array of strings that tell which methods in which
files, and on which lines have been called so far, so we can &ldquo;trace&rdquo; the method
call back.</p>

<p>The method that lets us grab this backtrace is the method <code>caller</code>. Let&rsquo;s try
adding this line at the very top of our method <code>assert_equal</code>:</p>
<pre class="highlight plaintext"><code>puts caller
</code></pre>

<p>When you run this code you&rsquo;ll see the backtrace printed, something like the
following:</p>
<pre class="highlight plaintext"><code>$ ruby -I . user.rb
test.rb:16:in `assert_false'
user.rb:25:in `test_not_born_in_leap_year_when_born_in_2001'
test.rb:8:in `run_test'
test.rb:4:in `block in run'
test.rb:4:in `each'
test.rb:4:in `run'
user.rb:40:in `&lt;main&gt;'
</code></pre>

<p>Ok, great!</p>

<p>So the backtrace that Ruby returns to us when we call <code>caller</code> includes the
method name that we are after: the test method that has, at some point in the
past, called the current method <code>assert_equal</code>.</p>

<p>All we have to do is filter this array for a line that includes <code>test_</code>, and
then extract the method name from that line:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Test</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nf">assert_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="nb">caller</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">line</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"test_"</span><span class="p">)</span> <span class="p">}</span>
    <span class="nb">method</span> <span class="o">=</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/(test_.*)'/</span> <span class="o">&amp;&amp;</span> <span class="vg">$1</span>
    <span class="k">if</span> <span class="n">expected</span> <span class="o">==</span> <span class="n">actual</span>
      <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> is </span><span class="si">#{</span><span class="n">expected</span><span class="si">}</span><span class="s2"> as expected."</span>
    <span class="k">else</span>
      <span class="nb">puts</span> <span class="s2">"KAPUTT! </span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">actual</span><span class="si">}</span><span class="s2"> is not </span><span class="si">#{</span><span class="n">expected</span><span class="si">}</span><span class="s2"> as expected."</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>If the code <code>line =~ /(test_.*)&#39;/ &amp;&amp; $1</code> on the second line looks confusing to
you, this is a regular expression that grabs the method name from the line in
the backtrace. The expression says:</p>

<p>&ldquo;Find a string that starts with <code>test_</code>, and then include all characters until
you find a single quote <code>&#39;</code>. Grab all these characters including <code>test_</code>, but
do not include the single quote.&rdquo;</p>

<p>Ruby&rsquo;s special variable <code>$1</code> will then include the characters grabbed by the
regular expression. (The correct term would be &ldquo;captured&rdquo;. This is everything
between the round parentheses inside the regular expression).</p>

<p>And with this change we&rsquo;ve got our method names back, even though we didn&rsquo;t
have to pass them to our assertion methods in each of our tests:</p>
<pre class="highlight plaintext"><code>KAPUTT! test_not_born_in_leap_year_when_born_in_2001 true is not false as expected.
test_not_born_in_leap_year_when_born_in_1900 false is false as expected.
test_born_in_leap_year_when_born_in_2000 true is true as expected.
test_born_in_leap_year_when_born_in_2004 true is true as expected.
</code></pre>

<p>Testing libraries come, essentially, with code like this.</p>

<p>They define classes and methods that make it easy for you to, as much as
possible, focus on what you want to test, and not to bother with the question
how to write these tests.</p>

<h2>Autorun</h2>

<p>Let&rsquo;s make one more tiny improvement, similar to what such testing libraries do:</p>

<p>Let&rsquo;s try to remove the two extra lines for instantiating our test class and
calling <code>run</code> on it:</p>
<pre class="highlight ruby"><code>  <span class="nb">test</span> <span class="o">=</span> <span class="no">UserTest</span><span class="p">.</span><span class="nf">new</span>
  <span class="nb">test</span><span class="p">.</span><span class="nf">run</span>
</code></pre>

<p>We&rsquo;ve just defined a test class, and, in this context, we can be fairly certain
that we want to run these tests, right? So not having to type these lines would
be kinda useful. Ruby could just automatically create an instance of the class
and call <code>run</code> on it whenever we define a class that inherits from <code>Test</code>.</p>

<p>How can we do that?</p>

<p>First of all we&rsquo;d want a way to find out all subclasses that have inherited from
the class <code>Test</code>. Rails adds a way to do that with the <a href="http://apidock.com/rails/v3.2.13/Class/subclasses">method <code>subclasses</code></a>.</p>

<p>Not using Rails though we need to add this ourselves:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Test</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">inherited</span><span class="p">(</span><span class="n">subclass</span><span class="p">)</span>
      <span class="n">subclasses</span> <span class="o">&lt;&lt;</span> <span class="n">subclass</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">subclasses</span>
      <span class="vi">@subclasses</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>

<p>The method <code>inherited</code> is called by Ruby every time the class is inherited, passing
the inheriting class (i.e. in our case the class <code>UserTest</code>). We keep track of all
these classes in the array that is stored on the instance variable <code>@subclasses</code>.</p>

<p>Now, how can we automatically run these tests?</p>

<p>There&rsquo;s another little trick that is so rarely used in day-to-day programming that
many Ruby programmers don&rsquo;t even know about it. You can tell Ruby to execute code
before it exits (i.e. terminates the program). And this is exactly what we want
to do, isn&rsquo;t it?</p>

<p>Here&rsquo;s how:</p>
<pre class="highlight ruby"><code><span class="nb">at_exit</span> <span class="k">do</span>
  <span class="no">Test</span><span class="p">.</span><span class="nf">subclasses</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">subclass</span><span class="o">|</span>
    <span class="nb">test</span> <span class="o">=</span> <span class="n">subclass</span><span class="p">.</span><span class="nf">new</span>
    <span class="nb">test</span><span class="p">.</span><span class="nf">run</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>The method <code>at_exit</code> takes a block that is called an &ldquo;exit hook&rdquo;. I.e. we tell
Ruby to execute the block that we&rsquo;ve hooked up right before Ruby terminates the
program, and &ldquo;exits&rdquo;.</p>

<p>In this block we take each of the subclasses of the class <code>Test</code> (in our case
that is going to be just one class, the class <code>UserTest</code>), instantiate it,
and call <code>run</code> on the instance.</p>

<p>Pretty neat.</p>

<p>We&rsquo;ve essentially implemented a really small, but actually useful testing
library ourselves, with just 45 lines of Ruby.</p>

<p>Let&rsquo;s look at some real world testing libraries next.</p>

        <nav class="page-nav"><a class="prev" href="/testing/stages.html">
  Previous
</a></nav>
        <nav class="page-nav"><a class="next" href="/libraries.html">
  Next
</a></nav>
      </article>
    </div>

    <footer>
      <ul>
        <li><a href="http://rubymonstas.org">Ruby Monstas</a></li>
        <li><a href="http://ruby-for-beginners.rubymonstas.org">Ruby For Beginners</a></li>
        <li><a href="http://webapps-for-beginners.rubymonstas.org">Webapps For Beginners</a></li>
        <li><a href="http://testing-for-beginners.rubymonstas.org">Testing For Beginners</a></li>
        <li><a href="mailto:ruby.monsters@gmail.com">Email</a></li>
        <li><a href="https://twitter.com/rubymonsters">Twitter</a></li>
        <li><a href="https://github.com/rubymonsters">GitHub</a></li>
        <li><a href="https://creativecommons.org/licenses/by-sa/2.0/" rel="license cc:license">License</a></li>
        <li><a href="http://foundation.travis-ci.org/imprint/">Imprint</a></li>
      </ul>
    </footer>

    <script src="../assets/javascripts/modernizr-4c875d94.js" type="text/javascript"></script>
    <script src="../assets/javascripts/monstas-79961449.js" type="text/javascript"></script>
  </body>
</html>
