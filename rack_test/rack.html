<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Testing for Beginners">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="BEd2YAbpSQrRqU2-5wUifTTzvqTMGLLE269b0JZTfCs" />

    <title>Testing a Rack app | Testing for Beginners</title>

    <link href="../assets/stylesheets/monstas-fe625f69.css" rel="stylesheet" type="text/css" />
    <link rel="icon" type="image/png" href="/assets/images/favicon-870787d6.png" />
  </head>

  <body>
    <nav class="page-nav"><a class="prev" href="/rack_test.html">
  Previous
</a></nav>
    <nav class="page-nav"><a class="next" href="/rack_test/sinatra.html">
  Next
</a></nav>

    <div>
      <nav class="toc">
        <h1>Contents</h1>
        <ul>
  <li>
    <a href="/index.html">
      Testing For Beginners
    </a>
  </li>
  <li>
    <a href="/preface.html">
      Preface
    </a>
  </li>
  <li class="directory">
    <a href="/testing.html">
      Testing Code
    </a>
    <ul>
      <li>
        <a href="/testing/output.html">
          Testing via output
        </a>
      </li>
      <li>
        <a href="/testing/separation.html">
          Separating test code
        </a>
      </li>
      <li>
        <a href="/testing/computed.html">
          Computed tests
        </a>
      </li>
      <li>
        <a href="/testing/assert.html">
          Assertions
        </a>
      </li>
      <li>
        <a href="/testing/stages.html">
          Stages of a test
        </a>
      </li>
      <li>
        <a href="/testing/classes.html">
          Test Classes
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/libraries.html">
      Libraries
    </a>
  </li>
  <li>
    <a href="/minitest.html">
      Minitest
    </a>
  </li>
  <li class="directory">
    <a href="/rspec.html">
      RSpec
    </a>
    <ul>
      <li>
        <a href="/rspec/basics.html">
          Basic Usage
        </a>
      </li>
      <li>
        <a href="/rspec/matchers.html">
          Matchers
        </a>
      </li>
      <li>
        <a href="/rspec/format.html">
          Format
        </a>
      </li>
      <li>
        <a href="/rspec/advanced.html">
          Advanced Usage
        </a>
      </li>
      <li>
        <a href="/rspec/custom_matchers.html">
          Custom Matchers
        </a>
      </li>
      <li>
        <a href="/rspec/filtering.html">
          Filtering
        </a>
      </li>
    </ul>
  </li>
  <li class="directory expanded">
    <a href="/rack_test.html">
      Rack::Test
    </a>
    <ul>
      <li class="active">
        <a href="/rack_test/rack.html">
          Testing a Rack app
        </a>
      </li>
      <li>
        <a href="/rack_test/sinatra.html">
          Testing a Sinatra app
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/headless.html">
      Headless browsers
    </a>
    <ul>
      <li>
        <a href="/headless/phantomjs.html">
          Phantom.js
        </a>
      </li>
      <li>
        <a href="/headless/capybara.html">
          Capybara
        </a>
      </li>
      <li>
        <a href="/headless/features.html">
          Feature tests
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/test_doubles.html">
      Test doubles
    </a>
  </li>
  <li>
    <a href="/analysis.html">
      Code Analysis
    </a>
  </li>
  <li>
    <a href="/services.html">
      Services
    </a>
  </li>
</ul>
      </nav>
      <article>
        <nav class="menu"><a href="#"></a></nav>
        <h1>Testing a Rack app</h1>

<p>Let&rsquo;s grab our very Rack application from the book
<a href="http://webapps-for-beginners.rubymonstas.org/rack/hello_world.html">Webapps for Beginners</a>.</p>

<p>It looked like this:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">Application</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">handle_request</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s2">"REQUEST_METHOD"</span><span class="p">],</span> <span class="n">env</span><span class="p">[</span><span class="s2">"PATH_INFO"</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">method</span> <span class="o">==</span> <span class="s2">"GET"</span>
        <span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">method_not_allowed</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/html"</span> <span class="p">},</span> <span class="p">[</span><span class="s2">"You have requested the path </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">, using GET"</span><span class="p">]]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">method_not_allowed</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
      <span class="p">[</span><span class="mi">405</span><span class="p">,</span> <span class="p">{},</span> <span class="p">[</span><span class="s2">"Method not allowed: </span><span class="si">#{</span><span class="nb">method</span><span class="si">}</span><span class="s2">"</span><span class="p">]]</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>How do we test such an app?</p>

<p>We could do this manually in RSpec like so:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">Application</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s2">"get to /ruby/monstas"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"returns the body"</span> <span class="k">do</span>
      <span class="n">env</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"PATH_INFO"</span> <span class="o">=&gt;</span> <span class="s2">"/ruby/monstas"</span> <span class="p">}</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
      <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">body</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="s2">"You have requested the path /ruby/monstas, using GET"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Or we could make some of this a little more reusable, like so:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">Application</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s2">"get to /ruby/monstas"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span>      <span class="p">{</span> <span class="no">Application</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:env</span><span class="p">)</span>      <span class="p">{</span> <span class="p">{</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"PATH_INFO"</span> <span class="o">=&gt;</span> <span class="s2">"/ruby/monstas"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:response</span><span class="p">)</span> <span class="p">{</span> <span class="n">app</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:body</span><span class="p">)</span>     <span class="p">{</span> <span class="n">response</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"returns the body"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">body</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="s2">"You have requested the path /ruby/monstas, using GET"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>And add a test for the status code:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">Application</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s2">"get to /ruby/monstas"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span>      <span class="p">{</span> <span class="no">Application</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:env</span><span class="p">)</span>      <span class="p">{</span> <span class="p">{</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"PATH_INFO"</span> <span class="o">=&gt;</span> <span class="s2">"/ruby/monstas"</span> <span class="p">}</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:response</span><span class="p">)</span> <span class="p">{</span> <span class="n">app</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:status</span><span class="p">)</span>   <span class="p">{</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:body</span><span class="p">)</span>     <span class="p">{</span> <span class="n">response</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"returns the status 200"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">200</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"returns the body"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">body</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="s2">"You have requested the path /ruby/monstas, using GET"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>This passes:</p>
<pre class="highlight plaintext"><code>$ rspec rack_spec.rb
..

Finished in 0.00086 seconds (files took 0.1486 seconds to load)
2 examples, 0 failures
</code></pre>

<p>Our Rack application is just a Ruby class which, when started (e.g. with
<code>rackup</code>), will be hooked up to the web server, and called whenever an HTTP
request comes in (e.g. from the browser).</p>

<p>But we can also just instantiate it ourselves, and call the method <code>call</code> with
a hash that complies to the Rack <code>env</code> conventions. E.g. in our case we&rsquo;d want
to set the <code>REQUEST_METHOD</code> and <code>PATH_INFO</code> keys.</p>

<p>While this works well it&rsquo;s also a little bit of a hassle. And that&rsquo;s where
Rack::Test can help.</p>

<p>Here&rsquo;s how we can use Rack::Test to make our tests a little less verbose:</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s2">"rack/test"</span>

<span class="n">describe</span> <span class="no">Application</span> <span class="k">do</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="n">context</span> <span class="s2">"get to /ruby/monstas"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span> <span class="p">{</span> <span class="no">Application</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"returns the status 200"</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s2">"/ruby/monstas"</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">last_response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">200</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"returns the body"</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s2">"/ruby/monstas"</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">last_response</span><span class="p">.</span><span class="nf">body</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="s2">"You have requested the path /ruby/monstas, using GET"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Rack::Test&rsquo;s helper methods expect that there&rsquo;s a method <code>app</code> defined, so they
can call it.  We can implement that using RSpec&rsquo;s handy <code>let</code> feature.</p>

<p>Now we first call the Rack::Test method <code>get</code> with our path. This method
creates the <code>env</code> hash for us, and calls <code>call</code> on the application. So we don&rsquo;t
have to compose the nasty hash ourselves.</p>

<p>After this, the method <code>last_response</code> will return the response that our
request has returned, and we can test it.</p>

<p>But the method <code>get</code> also returns the same response. So we could make this
a little more concise, and remove the duplicate call <code>get &quot;/ruby/monstas&quot;</code> like
this:</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s2">"rack/test"</span>

<span class="n">describe</span> <span class="no">Application</span> <span class="k">do</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="n">context</span> <span class="s2">"get to /ruby/monstas"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span>      <span class="p">{</span> <span class="no">Application</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:response</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span> <span class="s2">"/ruby/monstas"</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">200</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s2">"/ruby/monstas, using GET"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>We can also remove the <code>include</code> line from our actual tests, and move it to
the RSpec configuration. This configuration normally would sit in a separate
file called <code>spec_helper.rb</code>, but for now we&rsquo;ll just move it above our test
code:</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s2">"rack/test"</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="no">Application</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s2">"get to /ruby/monstas"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span>      <span class="p">{</span> <span class="no">Application</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:response</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span> <span class="s2">"/ruby/monstas"</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">200</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s2">"/ruby/monstas, using GET"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Nice.</p>

<p>Let&rsquo;s add another test for the case when an unsupported HTTP method is used:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">Application</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span> <span class="p">{</span> <span class="no">Application</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s2">"get to /ruby/monstas"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:response</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span> <span class="s2">"/ruby/monstas"</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">200</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">).</span><span class="nf">to</span> <span class="kp">include</span> <span class="s2">"/ruby/monstas, using GET"</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"post to /"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:response</span><span class="p">)</span> <span class="p">{</span> <span class="n">post</span> <span class="s2">"/"</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="mi">405</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span> <span class="s2">"Method not allowed: POST"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>As you see we&rsquo;ve moved the <code>let(:app)</code> statement one level up so it can be
shared among both contexts. the <code>let(:response)</code> statement on the other
hand is different for both contexts, so we kept them there.</p>

<p>Again, this passes:</p>
<pre class="highlight plaintext"><code>$ rspec rack_spec.rb
....

Finished in 0.01175 seconds (files took 0.21704 seconds to load)
4 examples, 0 failures
</code></pre>

<p>Very cool. We&rsquo;ve used RSpec and Rack::Test to write a few tests for the
functionality in our first Rack application.</p>

<p>Let&rsquo;s head over to the next chapter and do the same for our Sinatra resource
from the Webapps for Beginners book. We&rsquo;ll see a few more Rack::Test helper
methods there.</p>

        <nav class="page-nav"><a class="prev" href="/rack_test.html">
  Previous
</a></nav>
        <nav class="page-nav"><a class="next" href="/rack_test/sinatra.html">
  Next
</a></nav>
      </article>
    </div>

    <footer>
      <ul>
        <li><a href="http://rubymonstas.org">Ruby Monstas</a></li>
        <li><a href="http://ruby-for-beginners.rubymonstas.org">Ruby For Beginners</a></li>
        <li><a href="http://webapps-for-beginners.rubymonstas.org">Webapps For Beginners</a></li>
        <li><a href="http://testing-for-beginners.rubymonstas.org">Testing For Beginners</a></li>
        <li><a href="mailto:ruby.monsters@gmail.com">Email</a></li>
        <li><a href="https://twitter.com/rubymonsters">Twitter</a></li>
        <li><a href="https://github.com/rubymonsters">GitHub</a></li>
        <li><a href="https://creativecommons.org/licenses/by-sa/2.0/" rel="license cc:license">License</a></li>
        <li><a href="http://foundation.travis-ci.org/imprint/">Imprint</a></li>
      </ul>
    </footer>

    <script src="../assets/javascripts/modernizr-4c875d94.js" type="text/javascript"></script>
    <script src="../assets/javascripts/monstas-79961449.js" type="text/javascript"></script>
  </body>
</html>
